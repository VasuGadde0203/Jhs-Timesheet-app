<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Sheet - Professional Time Tracking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-bg: #2c3e50;
            --light-bg: #f8f9fa;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #e1e8ed;
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 10px 25px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--primary-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .navbar {
            background: var(--dark-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-medium);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar .hamburger {
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: var(--transition);
        }

        .navbar .hamburger:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .nav-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--dark-bg);
            width: 250px;
            border-radius: 0 0 10px 10px;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
        }

        .nav-menu.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-menu a, .nav-menu button {
            display: block;
            color: white;
            padding: 1rem 1.5rem;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-menu a:last-child, .nav-menu button:last-child {
            border-bottom: none;
        }

        .nav-menu a:hover, .nav-menu button:hover {
            background: var(--secondary-gradient);
            color: white;
            transform: translateX(5px);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 10"><defs><pattern id="grain" width="100" height="10" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="10" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
        }

        .header h1 {
            margin: 0;
            font-size: 2.8rem;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.95;
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
        }

        .form-section, .history-section {
            padding: 3rem;
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-section.active, .history-section.active {
            display: block;
        }

        .employee-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--light-bg);
            border-radius: 15px;
            border-left: 5px solid #3498db;
            box-shadow: var(--shadow-light);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }

        .timesheet-section {
            margin-bottom: 1.5rem;
            padding: 2rem;
            background: var(--light-bg);
            border-radius: 15px;
            border-left: 5px solid #3498db;
            position: relative;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .timesheet-section:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .delete-week-btn {
            background: var(--danger-gradient);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            position: absolute;
            top: 1rem;
            right: 1rem;
            transition: var(--transition);
            font-weight: 500;
        }

        .delete-week-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .week-period {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .week-period label {
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .timesheet-table, .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            display: block;
            overflow-x: auto;
            min-width: 1000px; /* Ensure enough width for scroll */
            white-space: nowrap;
        }

        .timesheet-table th, .history-table th {
            background: var(--dark-bg);
            color: white;
            padding: 1rem 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .timesheet-table td, .history-table td {
            padding: 1rem 0.75rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            white-space: nowrap;
            transition: var(--transition);
        }

        .timesheet-table tr:nth-child(even), .history-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .timesheet-table tr:hover, .history-table tr:hover {
            background: #e3f2fd;
            transform: scale(1.01);
        }

        .timesheet-table input,
        .timesheet-table select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            box-sizing: border-box;
            white-space: nowrap;
            transition: var(--transition);
        }

        .timesheet-table input[type="number"] {
            width: 80px;
        }

        .timesheet-table input[type="date"], .timesheet-table input[type="time"] {
            width: 140px;
        }

        .eye-btn, .edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            color: #3498db;
            border-radius: 50%;
            transition: var(--transition);
        }

        .eye-btn:hover, .edit-btn:hover {
            color: var(--text-dark);
            background: rgba(52, 152, 219, 0.1);
            transform: scale(1.1);
        }

        .cancel-btn, .update-btn {
            background: var(--danger-gradient);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 0.25rem;
            transition: var(--transition);
            font-weight: 500;
        }

        .update-btn {
            background: var(--success-gradient);
        }

        .cancel-btn:hover, .update-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .add-row-btn, .add-week-btn {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 1rem 0;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
        }

        .add-row-btn:hover, .add-week-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .export-btn, .clear-btn {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0.5rem;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
        }

        .clear-btn {
            background: var(--danger-gradient);
        }

        .export-btn:hover, .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
            padding: 2rem;
            background: var(--light-bg);
            border-radius: 15px;
            border-left: 5px solid #e74c3c;
            box-shadow: var(--shadow-light);
        }

        .summary-item {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .summary-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .summary-item h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-dark);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .summary-item .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #e74c3c;
            margin-top: 0.5rem;
        }

        .feedback-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
            padding: 2rem;
            background: var(--light-bg);
            border-radius: 15px;
            border-left: 5px solid #2ecc71;
            box-shadow: var(--shadow-light);
        }

        .feedback-item {
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .feedback-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .feedback-item label {
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .feedback-item textarea {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: var(--transition);
        }

        .feedback-item textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .export-section, .history-export-section {
            text-align: center;
            margin: 2rem 0;
            padding: 2rem;
            background: var(--light-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-light);
        }

        .export-section h3, .history-export-section h3 {
            margin-top: 0;
            color: var(--text-dark);
            font-weight: 600;
        }

        .history-table {
            font-size: 0.9rem;
        }

        .col-narrow { width: 60px; }
        .col-medium { width: 120px; }
        .col-wide { width: 200px; }
        .col-client { width: 250px; }
        .col-project { width: 200px; }

        .validation-error {
            border-color: #e74c3c !important;
            background-color: #fdf2f2 !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }

        .validation-message {
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .error-message {
            color: #e74c3c;
            font-size: 1rem;
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: #fdf2f2;
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; /* Increased gap for better spacing */
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-align: left; /* Ensure labels are left-aligned */
        }

        .modal-content div {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align items to the start for consistency */
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
            box-sizing: border-box; /* Ensure padding doesn't affect width */
        }

        .modal-content input:focus,
        .modal-content select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .modal-add-btn, .modal-cancel-btn {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1rem;
            transition: var(--transition);
            grid-column: 1 / -1;
            justify-self: center;
            box-shadow: var(--shadow-light);
        }

        .modal-cancel-btn {
            background: var(--danger-gradient);
            margin-right: 1rem;
        }

        .modal-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .modal-cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--success-gradient);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow-heavy);
            z-index: 2000;
            text-align: center;
            animation: popIn 0.3s ease-out;
            min-width: 300px;
        }

        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .popup.error {
            background: var(--danger-gradient);
        }

        .popup-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .popup-close:hover {
            transform: rotate(90deg);
        }

        .loading-bar {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary-gradient);
            color: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            z-index: 2000;
            text-align: center;
            box-shadow: var(--shadow-heavy);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        @media (max-width: 1200px) {
            .container {
                margin: 1rem;
                border-radius: 15px;
            }

            .header {
                padding: 2rem 1rem;
            }

            .header h1 {
                font-size: 2.2rem;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
            }

            .nav-menu {
                width: 100%;
                left: 0;
            }

            .container {
                margin: 0.5rem;
                border-radius: 10px;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 1rem;
            }

            .form-section, .history-section {
                padding: 1.5rem;
            }

            .employee-info {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1.5rem;
            }

            .timesheet-section {
                padding: 1.5rem;
            }

            .timesheet-table, .history-table {
                font-size: 0.8rem;
                min-width: 1000px; /* Consistent scrollable width */
            }

            .summary-section {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1.5rem;
            }

            .feedback-section {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1.5rem;
            }

            .export-section, .history-export-section {
                padding: 1.5rem;
                margin: 1rem 0;
            }

            .export-btn, .clear-btn {
                display: block;
                width: 100%;
                margin: 0.5rem 0;
            }

            .col-client { width: 150px; }
            .col-project { width: 120px; }

            .modal-content {
                grid-template-columns: 1fr;
                width: 95%;
                padding: 1.5rem;
                gap: 1rem;
            }

            .modal-add-btn, .modal-cancel-btn {
                width: 100%;
                margin: 0.5rem 0;
            }

            .modal-cancel-btn {
                margin-right: 0;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .form-section, .history-section {
                padding: 1rem;
            }

            .employee-info {
                padding: 1rem;
            }

            .timesheet-section {
                padding: 1rem;
            }

            .summary-section {
                padding: 1rem;
            }

            .feedback-section {
                padding: 1rem;
            }

            .export-section, .history-export-section {
                padding: 1rem;
            }

            .timesheet-table th, .history-table th {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }

            .timesheet-table td, .history-table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }

            .add-row-btn, .add-week-btn {
                width: 100%;
                padding: 1rem;
            }
        }

        @media (min-width: 1400px) {
            .container {
                max-width: 1600px;
            }

            .employee-info {
                grid-template-columns: repeat(3, 1fr);
            }
        }
                .logo-container {
            margin-bottom: 1rem;
            text-align: center;
        }
        .jhs-logo {
            max-width: 200px;
            height: auto;
            display: block;
            margin: 0 auto;
            transition: var(--transition);
        }
        @media (max-width: 768px) {
            .jhs-logo {
                max-width: 150px;
            }
        }
        @media (max-width: 480px) {
            .jhs-logo {
                max-width: 120px;
            }
        }
        .validation-error {
            border-color: #e74c3c !important;
            background-color: #fdf2f2 !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }
        .validation-message {
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            font-style: italic;
            text-align: left;
        }
        .exit-confirmation {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow-heavy);
            z-index: 2000;
            text-align: center;
            animation: popIn 0.3s ease-out;
            min-width: 300px;
        }
        .exit-confirmation p {
            margin: 0 0 1.5rem 0;
            font-size: 1.1rem;
            color: var(--text-dark);
        }
        .exit-confirmation button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0.5rem;
            transition: var(--transition);
        }
        .exit-confirmation .confirm-btn {
            background: var(--success-gradient);
            color: white;
        }
        .exit-confirmation .cancel-btn {
            background: var(--danger-gradient);
            color: white;
        }
        .exit-confirmation button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="hamburger" onclick="toggleNavMenu()"><i class="fas fa-bars"></i></div>
        <div class="nav-menu" id="navMenu">
            <a href="#" onclick="showSection('timesheet')"><i class="fas fa-clock"></i> Timesheet</a>
            <a href="#" onclick="showSection('history')"><i class="fas fa-history"></i> History</a>
            <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="jhs_logo.png" alt="JHS Logo" class="jhs-logo">
            </div>
            <h1><i class="fas fa-stopwatch"></i> JHS Time Sheet</h1>
            <!-- <p>Advanced Time Tracking & Project Management System</p> -->
        </div>
        
        <div class="form-section active" id="timesheetSection">
            <div id="errorMessage" class="error-message"></div>
            <div class="employee-info">
                <div class="form-group">
                    <label>Employee ID</label>
                    <input type="text" id="employeeId" readonly>
                </div>
                <div class="form-group">
                    <label>Employee Name</label>
                    <input type="text" id="employeeName" readonly>
                </div>
                <div class="form-group">
                    <label>Designation</label>
                    <input type="text" id="designation" readonly>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <input type="text" id="gender" readonly>
                </div>
                <div class="form-group">
                    <label>Partner</label>
                    <input type="text" id="partner" readonly>
                </div>
                <div class="form-group">
                    <label>Reporting Manager</label>
                    <input type="text" id="reportingManager" readonly>
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <select id="department">
                        <option value="">Select Department</option>
                        <option value="Statutory Audit">Statutory Audit</option>
                        <option value="Tax Services">Tax Services</option>
                        <option value="Corporate Finance">Corporate Finance</option>
                        <option value="Consulting">Consulting</option>
                        <option value="Compliance">Compliance</option>
                        <option value="Internal/Admin">Internal/Admin</option>
                        <option value="Concurrent Audit">Concurrent Audit</option>
                    </select>
                </div>
            </div>

            <div id="timesheetSections">
                <!-- Initial timesheet section will be added by JavaScript -->
            </div>

            <button class="add-week-btn" onclick="addWeekSection()"><i class="fas fa-plus"></i> Add Week Period</button>
            
            <div class="feedback-section">
                <div class="feedback-item">
                    <label>3 HITS</label>
                    <textarea id="hits" rows="3"></textarea>
                </div>
                <div class="feedback-item">
                    <label>3 MISSES</label>
                    <textarea id="misses" rows="3"></textarea>
                </div>
                <div class="feedback-item">
                    <label>FEEDBACK FOR HR</label>
                    <textarea id="feedback_hr" rows="3"></textarea>
                </div>
                <div class="feedback-item">
                    <label>FEEDBACK FOR IT</label>
                    <textarea id="feedback_it" rows="3"></textarea>
                </div>
                <div class="feedback-item">
                    <label>FEEDBACK FOR CRM</label>
                    <textarea id="feedback_crm" rows="3"></textarea>
                </div>
                <div class="feedback-item">
                    <label>FEEDBACK FOR OTHERS</label>
                    <textarea id="feedback_others" rows="3"></textarea>
                </div>
            </div>

            <div class="summary-section">
                <div class="summary-item total-hours">
                    <h3><i class="fas fa-clock"></i> Total Hours</h3>
                    <div class="value">0.00</div>
                </div>
                <div class="summary-item billable-hours">
                    <h3><i class="fas fa-dollar-sign"></i> Billable Hours</h3>
                    <div class="value">0.00</div>
                </div>
                <div class="summary-item non-billable-hours">
                    <h3><i class="fas fa-exclamation-triangle"></i> Non-Billable Hours</h3>
                    <div class="value">0.00</div>
                </div>
            </div>

            <div class="export-section">
                <h3><i class="fas fa-download"></i> Export Timesheet</h3>
                <button class="export-btn" onclick="exportTimesheetToExcel()"><i class="fas fa-file-excel"></i> Export to Excel</button>
                <button class="export-btn" onclick="saveDataToMongo()"><i class="fas fa-save"></i> Save</button>
                <button class="clear-btn" onclick="clearTimesheet()"><i class="fas fa-eraser"></i> Clear</button>
            </div>
        </div>

        <div class="history-section" id="historySection">
            <h2><i class="fas fa-history"></i> Past Timesheet Entries</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th class="col-narrow"><i class="fas fa-edit"></i> Edit</th>
                        <th>Week Period</th>
                        <th>Date</th>
                        <th>Location</th>
                        <th>Project Start</th>
                        <th>Project End</th>
                        <th>Punch In</th>
                        <th>Punch Out</th>
                        <th class="col-client">Client</th>
                        <th class="col-project">Project</th>
                        <th>Project Code</th>
                        <th>Reporting Manager</th>
                        <th>Activity</th>
                        <th>Project Hours</th>
                        <th class="col-medium">Billable</th>
                        <th>Remarks</th>
                        <th>3 HITS</th>
                        <th>3 MISSES</th>
                        <th>FEEDBACK FOR HR</th>
                        <th>FEEDBACK FOR IT</th>
                        <th>FEEDBACK FOR CRM</th>
                        <th>FEEDBACK FOR OTHERS</th>
                        <th>Created Time</th>
                        <th>Updated Time</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
            <div class="history-export-section">
                <h3><i class="fas fa-download"></i> Export History</h3>
                <button class="export-btn" onclick="exportHistoryToExcel()"><i class="fas fa-file-excel"></i> Export History to Excel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div><label id="modalLabel1">Date</label><input type="date" id="modalInput1" onchange="validateModalDate(this); updateModalHours()"></div>
            <div><label id="modalLabel2">Location</label><select id="modalInput2" onchange="updateModalClientFields()"><option value="Office">Office</option><option value="Client Site">Client Site</option><option value="Work From Home">Work From Home</option><option value="Field Work">Field Work</option></select></div>
            <div><label id="modalLabel3">Punch In</label><input type="time" id="modalInput3" onchange="validateTimes(null, true); updateModalHours()"></div>
            <div><label id="modalLabel4">Punch Out</label><input type="time" id="modalInput4" onchange="validateTimes(null, true); updateModalHours()"></div>
            <div><label id="modalLabel5">Project Start</label><input type="time" id="modalInput5" onchange="validateTimes(null, true); updateModalHours()"></div>
            <div><label id="modalLabel6">Project End</label><input type="time" id="modalInput6" onchange="validateTimes(null, true); updateModalHours()"></div>
            <div><label id="modalLabel7">Client</label><select id="modalInput7" onchange="updateModalProjectCode()"><option value="">Select Client</option></select></div>
            <div><label id="modalLabel8">Project</label><input type="text" id="modalInput8" placeholder="Enter Project" onchange="updateModalHours()"></div>
            <div><label id="modalLabel9">Project Code</label><input type="text" id="modalInput9" readonly></div>
            <div><label id="modalLabel10">Reporting Manager</label><select id="modalInput10" onchange="updateModalHours()"><option value="">Select Reporting Manager</option></select></div>
            <div><label id="modalLabel11">Activity</label><input type="text" id="modalInput11" placeholder="Enter Activity" onchange="updateModalHours()"></div>
            <div><label id="modalLabel12">Project Hours</label><input type="number" id="modalInput12" readonly></div>
            <div><label id="modalLabel13">Billable</label><select id="modalInput13" onchange="updateModalHours()"><option value="Yes">Billable</option><option value="No">Non-Billable</option></select></div>
            <div><label id="modalLabel14">Remarks</label><input type="text" id="modalInput14" placeholder="Additional notes" onchange="updateModalHours()"></div>
            <button class="modal-cancel-btn" onclick="closeModal()"><i class="fas fa-times"></i> Cancel</button>
            <button class="modal-add-btn" onclick="saveModalEntry()"><i class="fas fa-check"></i> Add</button>
        </div>
    </div>

    <div class="popup" id="successPopup">
        <button class="popup-close" onclick="closePopup()">&times;</button>
        <p id="popupMessage"><i class="fas fa-check-circle"></i></p>
    </div>

    <div class="loading-bar" id="loadingBar"><i class="fas fa-spinner fa-spin"></i> Saving...</div>

    <div class="exit-confirmation" id="exitConfirmation">
    <p>Do you want to exit?</p>
    <button class="cancel-btn" onclick="cancelExit()">No</button>
    <button class="confirm-btn" onclick="confirmExit()">Yes</button>
    </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let rowCount = 0;
        let sectionCount = 0;
        let employeeData = [];
        let clientData = [];
        let currentRow = null;
        let weekOptions = [];
        let loggedInEmployeeId = localStorage.getItem('loggedInEmployeeId');
        const API_URL = '';

        // Add this right after const API_URL = '';
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/';  // Redirect to login if no token
                return;
            }

            // Verify session
            try {
                const response = await fetch('/verify_session', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('loggedInEmployeeId');
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                console.error('Session verification failed:', error);
                localStorage.removeItem('access_token');
                localStorage.removeItem('loggedInEmployeeId');
                window.location.href = '/';
                return;
            }

            // Your existing code continues here...
            await checkSession();  // This can stay, but it might be redundant now
            // ... rest of your existing DOMContentLoaded code
        });

        async function checkSession() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            try {
                const response = await fetch(`${API_URL}/verify_session`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('loggedInEmployeeId');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Session check failed:', error);
                localStorage.removeItem('access_token');
                localStorage.removeItem('loggedInEmployeeId');
                window.location.href = 'login.html';
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await checkSession();
            if (loggedInEmployeeId) {
                employeeData = await fetchData('/employees');
                clientData = await fetchData('/clients');
                computeWeekOptions();
                await populateEmployeeInfo();
                addWeekSection();
                showSection('timesheet');
            }
        });

        async function fetchData(endpoint) {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = 'login.html';
                    return [];
                }
                const response = await fetch(`${API_URL}${endpoint}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('loggedInEmployeeId');
                        window.location.href = 'login.html';
                    }
                    throw new Error(`Failed to fetch ${endpoint}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                showError(`Error fetching ${endpoint.split('/')[1]} data. Please try again.`);
                return [];
            }
        }

        function computeWeekOptions() {
            const today = new Date(2025, 8, 8);
            const payroll = getPayrollPeriod(today);
            weekOptions = generateWeekOptions(payroll.start, payroll.end);
        }

        function getPayrollPeriod(today) {
            let start = new Date(2025, 7, 21);
            let end = new Date(2025, 8, 20);
            return { start, end };
        }

        function generateWeekOptions(start, end) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let weeks = [];
            let current = new Date(start);
            let weekNum = 1;
            while (current <= end) {
                let weekStart = new Date(current);
                let daysToSunday = (7 - weekStart.getDay()) % 7;
                let weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + daysToSunday);
                if (weekEnd > end) {
                    weekEnd = new Date(end);
                }
                let wsDay = weekStart.getDate().toString().padStart(2, '0');
                let wsMonth = months[weekStart.getMonth()];
                let weDay = weekEnd.getDate().toString().padStart(2, '0');
                let weMonth = months[weekEnd.getMonth()];
                let value = `${wsDay}/${weekStart.getMonth() + 1}/${weekStart.getFullYear()} to ${weDay}/${weekEnd.getMonth() + 1}/${weekEnd.getFullYear()}`;
                let text = `Week ${weekNum} (${wsDay} ${wsMonth} - ${weDay} ${weMonth})`;
                weeks.push({ value, text, start: weekStart, end: weekEnd });
                current = new Date(weekEnd);
                current.setDate(current.getDate() + 1);
                weekNum++;
            }
            return weeks;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function showPopup(message, isError = false) {
            const popup = document.getElementById('successPopup');
            const popupMessage = document.getElementById('popupMessage');
            popupMessage.textContent = message;
            popup.className = 'popup' + (isError ? ' error' : '');
            popup.style.display = 'block';
            setTimeout(closePopup, 3000);
        }

        function closePopup() {
            document.getElementById('successPopup').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loadingBar').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingBar').style.display = 'none';
        }

        function fetchEmployeeData(empId) {
            const cleanEmpId = empId.trim();
            const employee = employeeData.find(e => e['EmpID']?.toString().trim() === cleanEmpId);
            if (!employee) {
                showError(`No employee found for ID: ${empId}`);
                return null;
            }
            return { ...employee };
        }

        async function populateEmployeeInfo() {
            const employee = fetchEmployeeData(loggedInEmployeeId);
            if (employee) {
                const fields = {
                    employeeId: employee['EmpID'] || '',
                    employeeName: employee['Emp Name'] || '',
                    designation: employee['Designation Name'] || '',
                    partner: employee['Partner'] || '',
                    reportingManager: employee['ReportingEmpName'] || '',
                    gender: employee['Gender'] === 'F' ? 'Female' : employee['Gender'] === 'M' ? 'Male' : ''
                };
                Object.entries(fields).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.value = value;
                });
                updateAllClientFields();
                updateAllReportingManagerFields();
            }
        }

        function fetchProjectData(tl, manager) {
            const cleanTL = tl ? tl.trim().toLowerCase() : '';
            const cleanManager = manager ? manager.trim().toLowerCase() : '';
            let projects = clientData.filter(p => 
                p['TLs/Manager']?.toString().trim().toLowerCase() === cleanTL || 
                p['TLs/Manager']?.toString().trim().toLowerCase() === cleanManager
            );
            projects = projects.map(p => {
                const cleaned = { ...p };
                cleaned['CLIENT NAME'] = cleanClientName(p['CLIENT NAME']);
                return cleaned;
            });
            const uniqueProjects = [];
            const seen = new Set();
            projects.forEach(p => {
                const key = `${p['PROJECT ID']}|${p['CLIENT NAME']}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueProjects.push(p);
                }
            });
            return uniqueProjects;
        }

        function cleanClientName(name) {
            if (!name) return "";
            name = name.replace(/_x000D_|\n|\r/g, '');
            return name.trim().replace(/\s+/g, ' ');
        }

        function getReportingManagers() {
            const managers = [...new Set(employeeData
                .map(e => e['ReportingEmpName'])
                .filter(m => m && typeof m === 'string' && m.trim()))];
            return managers;
        }

        function updateAllClientFields() {
            const sections = document.querySelectorAll('.timesheet-section, .history-table');
            const tl = document.getElementById('partner')?.value || '';
            const manager = document.getElementById('reportingManager')?.value || '';
            const relevantProjects = fetchProjectData(tl, manager);
            
            sections.forEach(section => {
                const clientFields = section.querySelectorAll('.client-field');
                clientFields.forEach(field => {
                    const row = field.closest('tr');
                    const projectCodeInput = row.querySelector('.project-code');
                    const currentClientValue = field.value || field.querySelector('option:checked')?.value || '';
                    
                    if (relevantProjects.length > 0) {
                        const select = document.createElement('select');
                        select.className = 'client-field client-select';
                        select.innerHTML = '<option value="">Select Client</option>';
                        relevantProjects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project['CLIENT NAME'];
                            option.textContent = project['CLIENT NAME'];
                            select.appendChild(option);
                        });
                        select.innerHTML += '<option value="Type here">Type here</option>';
                        select.dataset.projects = JSON.stringify(relevantProjects);
                        select.onchange = () => handleClientChange(select);
                        if (currentClientValue && (relevantProjects.some(p => p['CLIENT NAME'] === currentClientValue) || currentClientValue === 'Type here')) {
                            select.value = currentClientValue;
                        }
                        field.replaceWith(select);
                        projectCodeInput.readOnly = select.value !== 'Type here';
                        updateProjectCode(select);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'client-field client-input';
                        input.placeholder = 'Enter Client';
                        input.value = currentClientValue;
                        input.oninput = () => {
                            projectCodeInput.readOnly = false;
                            projectCodeInput.placeholder = 'Enter Project Code';
                            updateSummary();
                        };
                        field.replaceWith(input);
                        projectCodeInput.readOnly = false;
                        projectCodeInput.placeholder = 'Enter Project Code';
                        projectCodeInput.oninput = updateSummary;
                    }
                });
            });
            updateModalClientFields();
        }

        function handleClientChange(select) {
            if (!select) return;
            const row = select.closest('tr');
            const projectCodeInput = row.querySelector('.project-code');
            if (select.value === 'Type here') {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'client-field client-input';
                input.placeholder = 'Enter Client';
                input.oninput = () => {
                    projectCodeInput.readOnly = false;
                    projectCodeInput.placeholder = 'Enter Project Code';
                    updateSummary();
                };
                select.replaceWith(input);
                projectCodeInput.readOnly = false;
                projectCodeInput.placeholder = 'Enter Project Code';
                projectCodeInput.oninput = updateSummary;
            } else {
                updateProjectCode(select);
            }
        }

        function updateProjectCode(clientSelect) {
            if (!clientSelect) return;
            const row = clientSelect.closest('tr');
            const projectCodeInput = row.querySelector('.project-code');
            const selectedClient = clientSelect.value;
            
            if (selectedClient === 'Type here') {
                projectCodeInput.readOnly = false;
                projectCodeInput.placeholder = 'Enter Project Code';
                projectCodeInput.value = '';
                projectCodeInput.oninput = updateSummary;
            } else {
                const projects = JSON.parse(clientSelect.dataset.projects || '[]');
                const project = projects.find(p => p['CLIENT NAME'] === selectedClient);
                projectCodeInput.value = project ? project['PROJECT ID'] : '';
                projectCodeInput.readOnly = true;
                updateSummary();
            }
        }

        function updateAllReportingManagerFields() {
            const sections = document.querySelectorAll('.timesheet-section, .history-table');
            const managers = getReportingManagers();
            const empReportingManager = document.getElementById('reportingManager')?.value || '';
            
            sections.forEach(section => {
                const reportingFields = section.querySelectorAll('.reporting-manager-field');
                reportingFields.forEach(field => {
                    const currentValue = field.value || field.querySelector('option:checked')?.value || '';
                    
                    const select = document.createElement('select');
                    select.className = 'reporting-manager-field reporting-manager-select';
                    select.innerHTML = '<option value="">Select Reporting Manager</option>';
                    if (empReportingManager) {
                        const option = document.createElement('option');
                        option.value = empReportingManager;
                        option.textContent = empReportingManager;
                        select.appendChild(option);
                    }
                    managers.forEach(manager => {
                        if (manager !== empReportingManager) {
                            const option = document.createElement('option');
                            option.value = manager;
                            option.textContent = manager;
                            select.appendChild(option);
                        }
                    });
                    select.innerHTML += '<option value="Type here">Type here</option>';
                    select.onchange = () => handleReportingManagerChange(select);
                    if (currentValue && (managers.includes(currentValue) || currentValue === empReportingManager || currentValue === 'Type here')) {
                        select.value = currentValue;
                    }
                    field.replaceWith(select);
                    if (select.value === 'Type here') {
                        handleReportingManagerChange(select);
                    }
                });
            });
            updateModalReportingManagerFields();
        }

        function handleReportingManagerChange(select) {
            if (!select) return;
            if (select.value === 'Type here') {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'reporting-manager-field reporting-manager-input';
                input.placeholder = 'Enter Reporting Manager';
                input.oninput = updateSummary;
                select.replaceWith(input);
            } else {
                updateSummary();
            }
        }

        function calculateHours(row) {
            if (!row) return;
            const isValid = validateTimes(row);
            if (!isValid) {
                const hoursField = row.querySelector('.hours-field');
                if (hoursField) hoursField.value = '';
                return;
            }

            const projectStart = row.querySelector('.project-start')?.value;
            const projectEnd = row.querySelector('.project-end')?.value;
            let hours = 0;

            if (projectStart && projectEnd) {
                const [startH, startM] = projectStart.split(':').map(Number);
                const [endH, endM] = projectEnd.split(':').map(Number);
                const startMinutes = startH * 60 + startM;
                const endMinutes = endH * 60 + endM;
                hours = (endMinutes - startMinutes) / 60;
                hours = Math.max(0, hours).toFixed(2);
            }

    const hoursField = row.querySelector('.hours-field');
    if (hoursField) {
        hoursField.value = hours > 0 ? hours : '';
    }
    updateSummary();
}

        function addWeekSection() {
            sectionCount++;
            const sectionsDiv = document.getElementById('timesheetSections');
            const sectionId = `section_${sectionCount}`;
            
            const section = document.createElement('div');
            section.className = 'timesheet-section';
            section.id = sectionId;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-week-btn';
            deleteBtn.textContent = 'Delete Week';
            deleteBtn.onclick = () => deleteWeekSection(sectionId);
            section.appendChild(deleteBtn);
            
            const weekPeriod = document.createElement('div');
            weekPeriod.className = 'week-period form-group';
            weekPeriod.innerHTML = `
                <label>Week Period ${sectionCount}</label>
            `;
            const select = document.createElement('select');
            select.id = `weekPeriod_${sectionCount}`;
            select.onchange = () => {
                updateSummary();
                updateDateValidations(sectionId);
                updateExistingRowDates(sectionId);
            };
            weekOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                select.appendChild(option);
            });
            if (weekOptions.length > 0) {
                select.value = weekOptions[0].value;
                setTimeout(() => {
                    select.onchange();
                }, 100);
            }
            weekPeriod.appendChild(select);
            section.appendChild(weekPeriod);
            
            const table = document.createElement('table');
            table.className = 'timesheet-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="col-narrow">S.No</th>
                        <th class="col-narrow"></th>
                        <th class="col-medium">Date</th>
                        <th class="col-wide">Location of Work</th>
                        <th class="col-medium">Project Start Time</th>
                        <th class="col-medium">Project End Time</th>
                        <th class="col-medium">Punch In</th>
                        <th class="col-medium">Punch Out</th>
                        <th class="col-client">Client</th>
                        <th class="col-wide">Project</th>
                        <th class="col-project">Project Code</th>
                        <th class="col-wide">Reporting Manager</th>
                        <th class="col-wide">Activity</th>
                        <th class="col-narrow">Project Hours</th>
                        <th class="col-medium">Billable</th>
                        <th class="col-wide">Remarks</th>
                        <th class="col-narrow">Action</th>
                    </tr>
                </thead>
                <tbody id="timesheetBody_${sectionCount}"></tbody>
            `;
            section.appendChild(table);
            
            const addRowBtn = document.createElement('button');
            addRowBtn.className = 'add-row-btn';
            addRowBtn.textContent = '+ Add New Entry';
            addRowBtn.onclick = () => addRow(sectionId);
            section.appendChild(addRowBtn);
            
            sectionsDiv.appendChild(section);
            addRow(sectionId);
            updateAllClientFields();
            updateAllReportingManagerFields();
            updateDateValidations(sectionId);
        }

        function addRow(sectionId) {
            const tbody = document.getElementById(`timesheetBody_${sectionId.split('_')[1]}`);
            if (!tbody) return;
            const rows = tbody.querySelectorAll('tr');
            const rowCount = rows.length + 1;
            
            const weekSelect = document.getElementById(`weekPeriod_${sectionId.split('_')[1]}`);
            const selectedWeekValue = weekSelect.value;
            const selectedWeek = weekOptions.find(opt => opt.value === selectedWeekValue);
            
            let defaultDate = new Date().toISOString().split('T')[0];
            if (selectedWeek && selectedWeek.start) {
                const weekStart = new Date(selectedWeek.start);
                defaultDate = `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`;
            } else if (weekOptions.length > 0) {
                const firstWeek = weekOptions[0];
                const weekStart = new Date(firstWeek.start);
                defaultDate = `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`;
            }
            
            console.log(`Adding row for section ${sectionId}, week: ${selectedWeekValue}, default date: ${defaultDate}`);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${rowCount}</td>
                <td><button class="eye-btn" onclick="openModal(this)"><i class="fas fa-eye"></i></button></td>
                <td><input type="date" value="${defaultDate}" class="date-field" onchange="validateDate(this); updateSummary()"></td>
                <td><select class="location-select" onchange="updateSummary()">
                    <option value="Office">Office</option>
                    <option value="Client Site">Client Site</option>
                    <option value="Work From Home">Work From Home</option>
                    <option value="Field Work">Field Work</option>
                </select></td>
                <td><input type="time" class="project-start" onchange="validateTimes(this.closest('tr')); calculateHours(this.closest('tr'))"></td>
                <td><input type="time" class="project-end" onchange="validateTimes(this.closest('tr')); calculateHours(this.closest('tr'))"></td>
                <td><input type="time" class="punch-in" onchange="validateTimes(this.closest('tr')); calculateHours(this.closest('tr'))"></td>
                <td><input type="time" class="punch-out" onchange="validateTimes(this.closest('tr')); calculateHours(this.closest('tr'))"></td>
                <td><select class="client-field client-select" onchange="handleClientChange(this)" data-projects="[]"><option value="">Select Client</option></select></td>
                <td><input type="text" class="project-field" placeholder="Enter Project" oninput="updateSummary()"></td>
                <td><input type="text" class="project-code" readonly></td>
                <td><select class="reporting-manager-field reporting-manager-select" onchange="handleReportingManagerChange(this)"><option value="">Select Reporting Manager</option></select></td>
                <td><input type="text" class="activity-field" placeholder="Enter Activity" oninput="updateSummary()"></td>
                <td><input type="number" class="hours-field" readonly></td>
                <td><select class="billable-select" onchange="updateSummary()">
                    <option value="Yes">Billable</option>
                    <option value="No">Non-Billable</option>
                </select></td>
                <td><input type="text" class="remarks-field" placeholder="Additional notes"></td>
                <td><button onclick="deleteRow(this)" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Delete</button></td>
            `;
            
            tbody.appendChild(row);
            updateAllClientFields();
            updateAllReportingManagerFields();
            
            const dateInput = row.querySelector('.date-field');
            if (dateInput) {
                validateDate(dateInput);
            }
            
            updateSummary();
        }

        function updateExistingRowDates(sectionId) {
            const tbody = document.getElementById(`timesheetBody_${sectionId.split('_')[1]}`);
            if (!tbody) return;
            
            const weekSelect = document.getElementById(`weekPeriod_${sectionId.split('_')[1]}`);
            const selectedWeekValue = weekSelect.value;
            const selectedWeek = weekOptions.find(opt => opt.value === selectedWeekValue);
            
            if (selectedWeek && selectedWeek.start) {
                const weekStart = new Date(selectedWeek.start);
                const defaultDate = `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`;
                
                const dateInputs = tbody.querySelectorAll('.date-field');
                dateInputs.forEach(dateInput => {
                    const currentDate = new Date(dateInput.value + 'T00:00:00');
                    const weekStartDate = new Date(weekStart);
                    const weekEndDate = new Date(selectedWeek.end);
                    
                    if (!dateInput.value || currentDate < weekStartDate || currentDate > weekEndDate) {
                        dateInput.value = defaultDate;
                        validateDate(dateInput);
                    }
                });
            }
        }

        function validateHours(hoursInput) {
            if (!hoursInput) return;
            const hours = parseFloat(hoursInput.value);
            if (hours > 16) {
                hoursInput.classList.add('validation-error');
                showValidationMessage(hoursInput, 'Hours cannot exceed 16 per day');
            } else {
                hoursInput.classList.remove('validation-error');
                clearValidationMessage(hoursInput);
            }
        }

        function validateDate(dateInput) {
            if (!dateInput) return;
            const section = dateInput.closest('.timesheet-section');
            const weekSelect = section.querySelector('.week-period select');
            const selectedWeek = weekOptions.find(opt => opt.value === weekSelect.value);
            if (!selectedWeek) return;

            const inputDate = new Date(dateInput.value);
            const weekStart = new Date(selectedWeek.start);
            const weekEnd = new Date(selectedWeek.end);

            if (inputDate < weekStart || inputDate > weekEnd) {
                dateInput.classList.add('validation-error');
                showValidationMessage(dateInput, 'Please select a date within the specified week only.');
            } else {
                dateInput.classList.remove('validation-error');
                clearValidationMessage(dateInput);
            }

            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            const sevenDaysAhead = new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000));
            
            if (inputDate < thirtyDaysAgo || inputDate > sevenDaysAhead) {
                dateInput.classList.add('validation-error');
                showValidationMessage(dateInput, 'Date must be within last 30 days to next 7 days');
            }
        }

        function validateModalDate(dateInput) {
            if (!dateInput || !currentRow) return;
            const section = currentRow.closest('.timesheet-section');
            const weekSelect = section.querySelector('.week-period select');
            const selectedWeek = weekOptions.find(opt => opt.value === weekSelect.value);
            if (!selectedWeek) return;

            const inputDate = new Date(dateInput.value);
            const weekStart = new Date(selectedWeek.start);
            const weekEnd = new Date(selectedWeek.end);

            if (inputDate < weekStart || inputDate > weekEnd) {
                dateInput.classList.add('validation-error');
                showValidationMessage(dateInput, 'Please select a date within the specified week only.');
            } else {
                dateInput.classList.remove('validation-error');
                clearValidationMessage(dateInput);
            }

            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            const sevenDaysAhead = new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000));
            
            if (inputDate < thirtyDaysAgo || inputDate > sevenDaysAhead) {
                dateInput.classList.add('validation-error');
                showValidationMessage(dateInput, 'Date must be within last 30 days to next 7 days');
            }
        }

        function showValidationMessage(element, message) {
            if (!element) return;
            clearValidationMessage(element);
            const msgDiv = document.createElement('div');
            msgDiv.className = 'validation-message';
            msgDiv.textContent = message;
            element.parentNode.appendChild(msgDiv);
        }

        function clearValidationMessage(element) {
            if (!element) return;
            const existingMsg = element.parentNode.querySelector('.validation-message');
            if (existingMsg) existingMsg.remove();
        }

        function deleteRow(button) {
            const row = button.closest('tr');
            if (row) {
                const tbody = row.closest('tbody');
                row.remove();
                updateRowNumbers(tbody.id);
                updateSummary();
            }
        }

        function updateRowNumbers(tbodyId) {
            const tbody = document.getElementById(tbodyId);
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        function deleteWeekSection(sectionId) {
            if (confirm('Are you sure you want to delete this week section?')) {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.remove();
                    updateSummary();
                }
            }
        }

        function openModal(button) {
            currentRow = button.closest('tr');
            const inputs = currentRow.querySelectorAll('input, select');
            
            const labels = [
                'Date', 'Location of Work', 'Project Start Time', 'Project End Time',
                'Punch In', 'Punch Out', 'Client', 'Project', 'Project Code',
                'Reporting Manager', 'Activity', 'Project Hours', 'Billable', 'Remarks'
            ];
            
            for (let i = 0; i < inputs.length; i++) {
                const label = document.getElementById(`modalLabel${i + 1}`);
                const input = document.getElementById(`modalInput${i + 1}`);
                if (label && input) {
                    label.textContent = labels[i];
                    input.value = inputs[i].value || '';
                    
                    if (input.tagName === 'SELECT') {
                        if (i === 6) {
                            const select = inputs[i];
                            const relevantProjects = fetchProjectData(document.getElementById('partner')?.value || '', document.getElementById('reportingManager')?.value || '');
                            input.innerHTML = '<option value="">Select Client</option>';
                            relevantProjects.forEach(project => {
                                const option = document.createElement('option');
                                option.value = project['CLIENT NAME'];
                                option.textContent = project['CLIENT NAME'];
                                input.appendChild(option);
                            });
                            input.innerHTML += '<option value="Type here">Type here</option>';
                            input.value = select.value || '';
                        } else if (i === 13) {
                            input.value = inputs[i].value || 'Yes';
                        }
                    }
                }
            }
            document.getElementById('modalOverlay').style.display = 'flex';
            updateModalClientFields();
            updateModalReportingManagerFields();
            validateModalDate(document.getElementById('modalInput1'));
            updateModalHours();
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            currentRow = null;
        }

        function updateModalClientFields() {
            const modalClientSelect = document.getElementById('modalInput7');
            const relevantProjects = fetchProjectData(document.getElementById('partner')?.value || '', document.getElementById('reportingManager')?.value || '');
            modalClientSelect.innerHTML = '<option value="">Select Client</option>';
            relevantProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project['CLIENT NAME'];
                option.textContent = project['CLIENT NAME'];
                modalClientSelect.appendChild(option);
            });
            modalClientSelect.innerHTML += '<option value="Type here">Type here</option>';
            if (currentRow) {
                const clientField = currentRow.querySelector('.client-field');
                modalClientSelect.value = clientField.value || clientField.querySelector('option:checked')?.value || '';
            }
        }

        function updateModalReportingManagerFields() {
            const modalManagerSelect = document.getElementById('modalInput10');
            const managers = getReportingManagers();
            const empReportingManager = document.getElementById('reportingManager')?.value || '';
            modalManagerSelect.innerHTML = '<option value="">Select Reporting Manager</option>';
            if (empReportingManager) {
                const option = document.createElement('option');
                option.value = empReportingManager;
                option.textContent = empReportingManager;
                modalManagerSelect.appendChild(option);
            }
            managers.forEach(manager => {
                if (manager !== empReportingManager) {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    modalManagerSelect.appendChild(option);
                }
            });
            modalManagerSelect.innerHTML += '<option value="Type here">Type here</option>';
            if (currentRow) {
                const managerField = currentRow.querySelector('.reporting-manager-field');
                modalManagerSelect.value = managerField.value || managerField.querySelector('option:checked')?.value || '';
            }
        }

        function updateModalProjectCode() {
            const modalClientSelect = document.getElementById('modalInput7');
            const modalProjectCodeInput = document.getElementById('modalInput9');
            if (modalClientSelect.value === 'Type here') {
                modalProjectCodeInput.readOnly = false;
                modalProjectCodeInput.placeholder = 'Enter Project Code';
                modalProjectCodeInput.value = '';
            } else {
                const projects = fetchProjectData(document.getElementById('partner')?.value || '', document.getElementById('reportingManager')?.value || '');
                const project = projects.find(p => p['CLIENT NAME'] === modalClientSelect.value);
                modalProjectCodeInput.value = project ? project['PROJECT ID'] : '';
                modalProjectCodeInput.readOnly = true;
            }
            updateModalHours();
        }

        function updateModalHours() {
            if (!currentRow) return;
            const projectStart = document.getElementById('modalInput5').value;
            const projectEnd = document.getElementById('modalInput6').value;
            const hoursField = document.getElementById('modalInput12');
            if (projectStart && projectEnd) {
                const [startH, startM] = projectStart.split(':').map(Number);
                const [endH, endM] = projectEnd.split(':').map(Number);
                const startMinutes = startH * 60 + startM;
                const endMinutes = endH * 60 + endM;
                let hours = (endMinutes - startMinutes) / 60;
                if (hours < 0) hours += 24;
                hoursField.value = hours.toFixed(2);
            } else {
                hoursField.value = '';
            }
        }

        function saveModalEntry() {
            if (!currentRow) return;
            const modalInputs = document.querySelectorAll('#modalOverlay input, #modalOverlay select');
            const rowInputs = currentRow.querySelectorAll('input, select');
            
            for (let i = 0; i < modalInputs.length; i++) {
                if (rowInputs[i].tagName === 'INPUT' && rowInputs[i].type !== 'button') {
                    rowInputs[i].value = modalInputs[i].value;
                } else if (rowInputs[i].tagName === 'SELECT') {
                    rowInputs[i].value = modalInputs[i].value;
                }
            }
            calculateHours(currentRow);
            validateDate(currentRow.querySelector('.date-field'));
            closeModal();
            updateSummary();
        }

        function updateSummary() {
            const sections = document.querySelectorAll('.timesheet-section');
            let totalHours = 0;
            let billableHours = 0;
            let nonBillableHours = 0;

            sections.forEach(section => {
                const rows = section.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const hours = parseFloat(row.querySelector('.hours-field').value) || 0;
                    totalHours += hours;
                    if (row.querySelector('.billable-select').value === 'Yes') {
                        billableHours += hours;
                    } else if (row.querySelector('.billable-select').value === 'No') {
                        nonBillableHours += hours;
                    }
                });
            });

            const totalHoursElement = document.querySelector('.summary-section .total-hours .value');
            const billableHoursElement = document.querySelector('.summary-section .billable-hours .value');
            const nonBillableHoursElement = document.querySelector('.summary-section .non-billable-hours .value');
            if (totalHoursElement) totalHoursElement.textContent = totalHours.toFixed(2);
            if (billableHoursElement) billableHoursElement.textContent = billableHours.toFixed(2);
            if (nonBillableHoursElement) nonBillableHoursElement.textContent = nonBillableHours.toFixed(2);
        }

        function exportTimesheetToExcel() {
            const wb = XLSX.utils.book_new();
            const employeeInfo = getEmployeeInfoForExport();
            let allData = [];

            allData.push(employeeInfo);

            const sections = document.querySelectorAll('.timesheet-section');
            sections.forEach((section) => {
                const weekPeriod = section.querySelector('.week-period select').value || '';
                const rows = section.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, select');
                    const rowData = {
                        'Employee ID': employeeInfo['Employee ID'],
                        'Employee Name': employeeInfo['Employee Name'],
                        'Designation': employeeInfo['Designation'],
                        'Gender': employeeInfo['Gender'],
                        'Partner': employeeInfo['Partner'],
                        'Reporting Manager': employeeInfo['Reporting Manager'],
                        'Department': document.getElementById('department').value || '',
                        'Week Period': weekPeriod,
                        'S.No': row.cells[0].textContent,
                        'Date': inputs[2] ? inputs[2].value : '',
                        'Location of Work': inputs[3] ? (inputs[3].value || inputs[3].querySelector('option:checked')?.value) : '',
                        'Project Start Time': inputs[4] ? inputs[4].value : '',
                        'Project End Time': inputs[5] ? inputs[5].value : '',
                        'Punch In': inputs[6] ? inputs[6].value : '',
                        'Punch Out': inputs[7] ? inputs[7].value : '',
                        'Client': inputs[8] ? (inputs[8].value || inputs[8].querySelector('option:checked')?.value) : '',
                        'Project': inputs[9] ? inputs[9].value : '',
                        'Project Code': inputs[10] ? inputs[10].value : '',
                        'Reporting Manager Entry': inputs[11] ? (inputs[11].value || inputs[11].querySelector('option:checked')?.value) : '',
                        'Activity': inputs[12] ? inputs[12].value : '',
                        'Project Hours': inputs[13] ? inputs[13].value : '',
                        'Billable': inputs[14] ? inputs[14].value : '',
                        'Remarks': inputs[15] ? inputs[15].value : '',
                        '3 HITS': document.getElementById('hits').value || '',
                        '3 MISSES': document.getElementById('misses').value || '',
                        'FEEDBACK FOR HR': document.getElementById('feedback_hr').value || '',
                        'FEEDBACK FOR IT': document.getElementById('feedback_it').value || '',
                        'FEEDBACK FOR CRM': document.getElementById('feedback_crm').value || '',
                        'FEEDBACK FOR OTHERS': document.getElementById('feedback_others').value || ''
                    };
                    allData.push(rowData);
                });
            });

            const ws = XLSX.utils.json_to_sheet(allData);
            XLSX.utils.book_append_sheet(wb, ws, 'Timesheet');
            XLSX.writeFile(wb, `Timesheet_${document.getElementById('employeeId').value || 'User'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function getEmployeeInfoForExport() {
            return {
                'Employee ID': document.getElementById('employeeId').value || '',
                'Employee Name': document.getElementById('employeeName').value || '',
                'Designation': document.getElementById('designation').value || '',
                'Gender': document.getElementById('gender').value || '',
                'Partner': document.getElementById('partner').value || '',
                'Reporting Manager': document.getElementById('reportingManager').value || '',
                'Department': document.getElementById('department').value || '',
                'Week Period': '',
                'S.No': '',
                'Date': '',
                'Location of Work': '',
                'Project Start Time': '',
                'Project End Time': '',
                'Punch In': '',
                'Punch Out': '',
                'Client': '',
                'Project': '',
                'Project Code': '',
                'Reporting Manager Entry': '',
                'Activity': '',
                'Project Hours': '',
                'Billable': '',
                'Remarks': '',
                '3 HITS': '',
                '3 MISSES': '',
                'FEEDBACK FOR HR': '',
                'FEEDBACK FOR IT': '',
                'FEEDBACK FOR CRM': '',
                'FEEDBACK FOR OTHERS': ''
            };
        }

        async function exportHistoryToExcel() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_URL}/timesheets/${loggedInEmployeeId}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch history for export');
                }
                const data = await response.json();
                const entries = Array.isArray(data.Data) ? data.Data : data.Data ? [data.Data] : [];

                const wb = XLSX.utils.book_new();
                const employeeInfo = getEmployeeInfoForExport();
                let allData = [];

                allData.push(employeeInfo);

                entries.forEach(entry => {
                    const rowData = {
                        'Employee ID': employeeInfo['Employee ID'],
                        'Employee Name': employeeInfo['Employee Name'],
                        'Designation': employeeInfo['Designation'],
                        'Gender': employeeInfo['Gender'],
                        'Partner': employeeInfo['Partner'],
                        'Reporting Manager': employeeInfo['Reporting Manager'],
                        'Department': document.getElementById('department').value || '',
                        'Week Period': entry.weekPeriod || '',
                        'S.No': '',
                        'Date': entry.date || '',
                        'Location of Work': entry.location || '',
                        'Project Start Time': entry.projectStartTime || '',
                        'Project End Time': entry.projectEndTime || '',
                        'Punch In': entry.punchIn || '',
                        'Punch Out': entry.punchOut || '',
                        'Client': entry.client || '',
                        'Project': entry.project || '',
                        'Project Code': entry.projectCode || '',
                        'Reporting Manager Entry': entry.reportingManagerEntry || '',
                        'Activity': entry.activity || '',
                        'Project Hours': entry.hours || '',
                        'Billable': entry.billable || '',
                        'Remarks': entry.remarks || '',
                        '3 HITS': entry.hits || '',
                        '3 MISSES': entry.misses || '',
                        'FEEDBACK FOR HR': entry.feedback_hr || '',
                        'FEEDBACK FOR IT': entry.feedback_it || '',
                        'FEEDBACK FOR CRM': entry.feedback_crm || '',
                        'FEEDBACK FOR OTHERS': entry.feedback_others || ''
                    };
                    allData.push(rowData);
                });

                const ws = XLSX.utils.json_to_sheet(allData);
                XLSX.utils.book_append_sheet(wb, ws, 'History');
                XLSX.writeFile(wb, `History_${document.getElementById('employeeId').value || 'User'}_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (error) {
                console.error('Error exporting history:', error);
                showPopup('Failed to export history: ' + error.message, true);
            }
        }

        async function saveDataToMongo() {
            showLoading();
            const employeeId = document.getElementById('employeeId').value.trim();
            if (!employeeId) {
                hideLoading();
                showPopup('Please enter Employee ID', true);
                return;
            }

            const timesheetData = [];
            const employeeDataObj = {
                employeeId: employeeId,
                employeeName: document.getElementById('employeeName').value || '',
                designation: document.getElementById('designation').value || '',
                gender: document.getElementById('gender').value || '',
                partner: document.getElementById('partner').value || '',
                reportingManager: document.getElementById('reportingManager').value || '',
                department: document.getElementById('department').value || '',
                weekPeriod: '',
                date: '',
                location: '',
                projectStartTime: '',
                projectEndTime: '',
                punchIn: '',
                punchOut: '',
                client: '',
                project: '',
                projectCode: '',
                reportingManagerEntry: '',
                activity: '',
                hours: '',
                billable: '',
                remarks: '',
                hits: document.getElementById('hits').value || '',
                misses: document.getElementById('misses').value || '',
                feedback_hr: document.getElementById('feedback_hr').value || '',
                feedback_it: document.getElementById('feedback_it').value || '',
                feedback_crm: document.getElementById('feedback_crm').value || '',
                feedback_others: document.getElementById('feedback_others').value || ''
            };

            const sections = document.querySelectorAll('.timesheet-section');
            let hasInvalidDates = false;
            sections.forEach(section => {
                const weekPeriod = section.querySelector('.week-period select').value || '';
                const rows = section.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input, select');
                    if (inputs.length < 14) return;
                    const dateInput = inputs[2];
                    const selectedWeek = weekOptions.find(opt => opt.value === weekPeriod);
                    if (selectedWeek) {
                        const inputDate = new Date(dateInput.value);
                        if (inputDate < selectedWeek.start || inputDate > selectedWeek.end) {
                            hasInvalidDates = true;
                            return;
                        }
                    }
                    const rowData = {
                        employeeId: employeeId,
                        employeeName: document.getElementById('employeeName').value || '',
                        designation: document.getElementById('designation').value || '',
                        gender: document.getElementById('gender').value || '',
                        partner: document.getElementById('partner').value || '',
                        reportingManager: document.getElementById('reportingManager').value || '',
                        department: document.getElementById('department').value || '',
                        weekPeriod: weekPeriod,
                        date: inputs[2] ? inputs[2].value : '',
                        location: inputs[3] ? (inputs[3].value || inputs[3].querySelector('option:checked')?.value) : '',
                        projectStartTime: inputs[4] ? inputs[4].value : '',
                        projectEndTime: inputs[5] ? inputs[5].value : '',
                        punchIn: inputs[6] ? inputs[6].value : '',
                        punchOut: inputs[7] ? inputs[7].value : '',
                        client: inputs[8] ? (inputs[8].value || inputs[8].querySelector('option:checked')?.value || '') : '',
                        project: inputs[9] ? inputs[9].value : '',
                        projectCode: inputs[10] ? inputs[10].value : '',
                        reportingManagerEntry: inputs[11] ? (inputs[11].value || inputs[11].querySelector('option:checked')?.value || '') : '',
                        activity: inputs[12] ? inputs[12].value : '',
                        hours: inputs[13] ? inputs[13].value : '',
                        billable: inputs[14] ? inputs[14].value : '',
                        remarks: inputs[15] ? inputs[15].value : '',
                        hits: document.getElementById('hits').value || '',
                        misses: document.getElementById('misses').value || '',
                        feedback_hr: document.getElementById('feedback_hr').value || '',
                        feedback_it: document.getElementById('feedback_it').value || '',
                        feedback_crm: document.getElementById('feedback_crm').value || '',
                        feedback_others: document.getElementById('feedback_others').value || ''
                    };
                    timesheetData.push(rowData);
                });
            });

            if (hasInvalidDates) {
                hideLoading();
                showPopup('Please correct all dates to be within their respective week periods.', true);
                return;
            }

            if (timesheetData.length === 0) {
                timesheetData.push(employeeDataObj);
            }

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_URL}/save_timesheets`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(timesheetData)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to save data: ${errorData.detail || response.statusText}`);
                }
                const result = await response.json();
                if (result.success) {
                    showPopup(`Data stored successfully at ${new Date().toLocaleString()}!`);
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    showPopup('No data was saved to the database.', true);
                }
            } catch (error) {
                console.error('Error saving to MongoDB:', error);
                showPopup(`Failed to save timesheet data: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        }

        function clearTimesheet() {
            showPopup('Timesheet cleared!');
            document.getElementById('hits').value = '';
            document.getElementById('misses').value = '';
            document.getElementById('feedback_hr').value = '';
            document.getElementById('feedback_it').value = '';
            document.getElementById('feedback_crm').value = '';
            document.getElementById('feedback_others').value = '';
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }

        function toggleNavMenu() {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('active');
        }

        async function logout() {
            showLoading();
            try {
                const token = localStorage.getItem('access_token');
                await fetch(`${API_URL}/logout`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (error) {
                console.error('Error during logout:', error);
            } finally {
                hideLoading();
                localStorage.removeItem('access_token');
                localStorage.removeItem('loggedInEmployeeId');
                window.location.href = 'login.html';
            }
        }

        async function showSection(section) {
            document.getElementById('timesheetSection').classList.remove('active');
            document.getElementById('historySection').classList.remove('active');
            document.getElementById('navMenu').classList.remove('active');
            
            if (section === 'history') {
                await loadHistory();
                document.getElementById('historySection').classList.add('active');
            } else {
                document.getElementById('timesheetSection').classList.add('active');
            }
        }

                async function loadHistory() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_URL}/timesheets/${loggedInEmployeeId}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('loggedInEmployeeId');
                        window.location.href = 'login.html';
                    }
                    throw new Error('Failed to fetch history');
                }
                const data = await response.json();
                const historyBody = document.getElementById('historyBody');
                historyBody.innerHTML = '';
                
                const entries = Array.isArray(data.Data) ? data.Data : data.Data ? [data.Data] : [];
                if (entries.length > 0) {
                    entries.forEach(entry => {
                        const row = document.createElement('tr');
                        row.dataset.entryId = entry.id;
                        row.innerHTML = `
                            <td><button class="edit-btn" onclick="editHistoryRow(this, '${entry.id}')"><i class="fas fa-edit"></i></button></td>
                            <td>${entry.weekPeriod || ''}</td>
                            <td>${entry.date || ''}</td>
                            <td>${entry.location || ''}</td>
                            <td>${entry.projectStartTime || ''}</td>
                            <td>${entry.projectEndTime || ''}</td>
                            <td>${entry.punchIn || ''}</td>
                            <td>${entry.punchOut || ''}</td>
                            <td>${entry.client || ''}</td>
                            <td>${entry.project || ''}</td>
                            <td>${entry.projectCode || ''}</td>
                            <td>${entry.reportingManagerEntry || ''}</td>
                            <td>${entry.activity || ''}</td>
                            <td>${entry.hours || ''}</td>
                            <td>${entry.billable || ''}</td>
                            <td>${entry.remarks || ''}</td>
                            <td>${entry.hits || ''}</td>
                            <td>${entry.misses || ''}</td>
                            <td>${entry.feedback_hr || ''}</td>
                            <td>${entry.feedback_it || ''}</td>
                            <td>${entry.feedback_crm || ''}</td>
                            <td>${entry.feedback_others || ''}</td>
                            <td>${entry.created_time || ''}</td>
                            <td>${entry.updated_time || ''}</td>
                        `;
                        historyBody.appendChild(row);
                    });
                    updateAllClientFields();
                    updateAllReportingManagerFields();
                } else {
                    historyBody.innerHTML = '<tr><td colspan="24">No history found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
                showPopup('Failed to load history: Server error', true);
            }
        }

        function editHistoryRow(button, entryId) {
            const row = button.closest('tr');
            const cells = row.querySelectorAll('td');
            const originalHtml = row.innerHTML;
            row.dataset.originalHtml = originalHtml;
            row.dataset.entryId = entryId;

            const data = {
                weekPeriod: cells[1].textContent,
                date: cells[2].textContent,
                location: cells[3].textContent,
                projectStartTime: cells[4].textContent,
                projectEndTime: cells[5].textContent,
                punchIn: cells[6].textContent,
                punchOut: cells[7].textContent,
                client: cells[8].textContent,
                project: cells[9].textContent,
                projectCode: cells[10].textContent,
                reportingManagerEntry: cells[11].textContent,
                activity: cells[12].textContent,
                hours: cells[13].textContent,
                billable: cells[14].textContent,
                remarks: cells[15].textContent,
                hits: cells[16].textContent,
                misses: cells[17].textContent,
                feedback_hr: cells[18].textContent,
                feedback_it: cells[19].textContent,
                feedback_crm: cells[20].textContent,
                feedback_others: cells[21].textContent,
                created_time: cells[22].textContent,
                updated_time: cells[23].textContent
            };

            cells[0].innerHTML = `
                <button class="cancel-btn" onclick="cancelEdit(this)">Cancel</button>
                <button class="update-btn" onclick="updateHistoryRow(this, '${entryId}')">Update</button>
            `;
            cells[1].innerHTML = `<input type="text" value="${data.weekPeriod}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">`;
            cells[2].innerHTML = `<input type="date" value="${data.date}" class="date-field">`;
            cells[3].innerHTML = `<select class="location-select">
                <option value="Office" ${data.location === 'Office' ? 'selected' : ''}>Office</option>
                <option value="Client Site" ${data.location === 'Client Site' ? 'selected' : ''}>Client Site</option>
                <option value="Work From Home" ${data.location === 'Work From Home' ? 'selected' : ''}>Work From Home</option>
                <option value="Field Work" ${data.location === 'Field Work' ? 'selected' : ''}>Field Work</option>
            </select>`;
            cells[4].innerHTML = `<input type="time" value="${data.projectStartTime}" class="project-start">`;
            cells[5].innerHTML = `<input type="time" value="${data.projectEndTime}" class="project-end">`;
            cells[6].innerHTML = `<input type="time" value="${data.punchIn}" class="punch-in" onchange="calculateHours(this.closest('tr'))">`;
            cells[7].innerHTML = `<input type="time" value="${data.punchOut}" class="punch-out" onchange="calculateHours(this.closest('tr'))">`;
            cells[8].innerHTML = `<select class="client-field client-select" data-projects="[]" onchange="handleClientChange(this)"><option value="">Select Client</option></select>`;
            cells[8].querySelector('select').value = data.client;
            cells[9].innerHTML = `<input type="text" value="${data.project}" class="project-field">`;
            cells[10].innerHTML = `<input type="text" value="${data.projectCode}" class="project-code" readonly>`;
            cells[11].innerHTML = `<select class="reporting-manager-field reporting-manager-select" onchange="handleReportingManagerChange(this)"><option value="">Select Reporting Manager</option></select>`;
            cells[11].querySelector('select').value = data.reportingManagerEntry;
            cells[12].innerHTML = `<input type="text" value="${data.activity}" class="activity-field">`;
            cells[13].innerHTML = `<input type="number" value="${data.hours}" class="hours-field" readonly>`;
            cells[14].innerHTML = `<select class="billable-select">
                <option value="Yes" ${data.billable === 'Yes' ? 'selected' : ''}>Billable</option>
                <option value="No" ${data.billable === 'No' ? 'selected' : ''}>Non-Billable</option>
            </select>`;
            cells[15].innerHTML = `<input type="text" value="${data.remarks}" class="remarks-field">`;
            cells[16].innerHTML = `<textarea rows="3">${data.hits}</textarea>`;
            cells[17].innerHTML = `<textarea rows="3">${data.misses}</textarea>`;
            cells[18].innerHTML = `<textarea rows="3">${data.feedback_hr}</textarea>`;
            cells[19].innerHTML = `<textarea rows="3">${data.feedback_it}</textarea>`;
            cells[20].innerHTML = `<textarea rows="3">${data.feedback_crm}</textarea>`;
            cells[21].innerHTML = `<textarea rows="3">${data.feedback_others}</textarea>`;
            cells[22].innerHTML = data.created_time;
            cells[23].innerHTML = data.updated_time;

            updateAllClientFields();
            updateAllReportingManagerFields();
        }

        function cancelEdit(button) {
            const row = button.closest('tr');
            row.innerHTML = row.dataset.originalHtml;
            delete row.dataset.originalHtml;
            delete row.dataset.entryId;
            updateAllClientFields();
            updateAllReportingManagerFields();
        }

        async function updateHistoryRow(button, entryId) {
            const row = button.closest('tr');
            if (!row) return;

            const cells = row.querySelectorAll('td');
            const weekPeriodCell = cells[1];
            const dateCell = cells[2];
            const locationCell = cells[3];
            const projectStartCell = cells[4];
            const projectEndCell = cells[5];
            const punchInCell = cells[6];
            const punchOutCell = cells[7];
            const clientCell = cells[8];
            const projectCell = cells[9];
            const projectCodeCell = cells[10];
            const reportingCell = cells[11];
            const activityCell = cells[12];
            const hoursCell = cells[13];
            const billableCell = cells[14];
            const remarksCell = cells[15];
            const hitsCell = cells[16];
            const missesCell = cells[17];
            const feedbackHrCell = cells[18];
            const feedbackItCell = cells[19];
            const feedbackCrmCell = cells[20];
            const feedbackOthersCell = cells[21];

            function getCellValue(cell) {
                const input = cell.querySelector('input');
                const select = cell.querySelector('select');
                const textarea = cell.querySelector('textarea');
                if (input) return input.value;
                if (select) return select.value;
                if (textarea) return textarea.value;
                return cell.textContent.trim();
            }

            const updatedEntry = {
                weekPeriod: getCellValue(weekPeriodCell),
                date: getCellValue(dateCell),
                location: getCellValue(locationCell),
                projectStartTime: getCellValue(projectStartCell),
                projectEndTime: getCellValue(projectEndCell),
                punchIn: getCellValue(punchInCell),
                punchOut: getCellValue(punchOutCell),
                client: getCellValue(clientCell),
                project: getCellValue(projectCell),
                projectCode: getCellValue(projectCodeCell),
                reportingManagerEntry: getCellValue(reportingCell),
                activity: getCellValue(activityCell),
                hours: getCellValue(hoursCell),
                billable: getCellValue(billableCell),
                remarks: getCellValue(remarksCell),
                hits: getCellValue(hitsCell),
                misses: getCellValue(missesCell),
                feedback_hr: getCellValue(feedbackHrCell),
                feedback_it: getCellValue(feedbackItCell),
                feedback_crm: getCellValue(feedbackCrmCell),
                feedback_others: getCellValue(feedbackOthersCell)
            };

            console.log('Updating entry with data:', updatedEntry);

            try {
                const token = localStorage.getItem('access_token');
                if (!token) throw new Error('No token found');
                const response = await fetch(`${API_URL}/update_timesheet/${loggedInEmployeeId}/${entryId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updatedEntry)
                });
                if (!response.ok) {
                    let errorMsg = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.detail || errorData.message || errorMsg;
                    } catch (e) {
                        // Ignore JSON parse error
                    }
                    throw new Error(`Failed to update entry: ${errorMsg}`);
                }
                const result = await response.json();
                if (result.success) {
                    showPopup(`Entry updated successfully at ${new Date().toLocaleString()}!`);
                    await loadHistory();
                } else {
                    showPopup('Failed to update entry.', true);
                }
            } catch (error) {
                console.error('Error updating entry:', error);
                showPopup(`Failed to update entry: ${error.message}`, true);
            }
        }

        function updateDateValidations(sectionId) {
            const section = document.getElementById(sectionId);
            const dateInputs = section.querySelectorAll('.date-field');
            dateInputs.forEach(input => validateDate(input));
        }

        function validateTimes(row, isModal = false) {
            let isValid = true;
            let errorMessage = '';

            if (isModal) {
                const projectStart = document.getElementById('modalInput5').value;
                const projectEnd = document.getElementById('modalInput6').value;
                const punchIn = document.getElementById('modalInput3').value;
                const punchOut = document.getElementById('modalInput4').value;

                if (projectStart && projectEnd) {
                    const [startH, startM] = projectStart.split(':').map(Number);
                    const [endH, endM] = projectEnd.split(':').map(Number);
                    const startMinutes = startH * 60 + startM;
                    const endMinutes = endH * 60 + endM;
                    if (endMinutes <= startMinutes) {
                        isValid = false;
                        errorMessage = 'Project End Time must be later than Project Start Time.';
                        document.getElementById('modalInput6').classList.add('validation-error');
                        showValidationMessage(document.getElementById('modalInput6'), errorMessage);
                    } else {
                        document.getElementById('modalInput6').classList.remove('validation-error');
                        clearValidationMessage(document.getElementById('modalInput6'));
                    }
                }

                if (punchIn && punchOut) {
                    const [inH, inM] = punchIn.split(':').map(Number);
                    const [outH, outM] = punchOut.split(':').map(Number);
                    const inMinutes = inH * 60 + inM;
                    const outMinutes = outH * 60 + outM;
                    if (outMinutes <= inMinutes) {
                        isValid = false;
                        errorMessage = errorMessage || 'Punch Out must be later than Punch In.';
                        document.getElementById('modalInput4').classList.add('validation-error');
                        showValidationMessage(document.getElementById('modalInput4'), errorMessage);
                    } else {
                        document.getElementById('modalInput4').classList.remove('validation-error');
                        clearValidationMessage(document.getElementById('modalInput4'));
                    }
                }
            } else {
                const projectStart = row.querySelector('.project-start')?.value;
                const projectEnd = row.querySelector('.project-end')?.value;
                const punchIn = row.querySelector('.punch-in')?.value;
                const punchOut = row.querySelector('.punch-out')?.value;

                if (projectStart && projectEnd) {
                    const [startH, startM] = projectStart.split(':').map(Number);
                    const [endH, endM] = projectEnd.split(':').map(Number);
                    const startMinutes = startH * 60 + startM;
                    const endMinutes = endH * 60 + endM;
                    if (endMinutes <= startMinutes) {
                        isValid = false;
                        errorMessage = 'Project End Time must be later than Project Start Time.';
                        row.querySelector('.project-end').classList.add('validation-error');
                        showValidationMessage(row.querySelector('.project-end'), errorMessage);
                    } else {
                        row.querySelector('.project-end').classList.remove('validation-error');
                        clearValidationMessage(row.querySelector('.project-end'));
                    }
                }

                if (punchIn && punchOut) {
                    const [inH, inM] = punchIn.split(':').map(Number);
                    const [outH, outM] = punchOut.split(':').map(Number);
                    const inMinutes = inH * 60 + inM;
                    const outMinutes = outH * 60 + outM;
                    if (outMinutes <= inMinutes) {
                        isValid = false;
                        errorMessage = errorMessage || 'Punch Out must be later than Punch In.';
                        row.querySelector('.punch-out').classList.add('validation-error');
                        showValidationMessage(row.querySelector('.punch-out'), errorMessage);
                    } else {
                        row.querySelector('.punch-out').classList.remove('validation-error');
                        clearValidationMessage(row.querySelector('.punch-out'));
                    }
                }
            }

            if (!isValid && errorMessage) {
                showPopup(errorMessage, true);
            }

            return isValid;
        }

        function showValidationMessage(element, message) {
            let validationDiv = element.nextElementSibling;
            if (!validationDiv || !validationDiv.classList.contains('validation-message')) {
                validationDiv = document.createElement('div');
                validationDiv.className = 'validation-message';
                element.parentNode.insertBefore(validationDiv, element.nextSibling);
            }
            validationDiv.textContent = message;
        }

        function clearValidationMessage(element) {
            const validationDiv = element.nextElementSibling;
            if (validationDiv && validationDiv.classList.contains('validation-message')) {
                validationDiv.remove();
            }
        }

        let isExiting = false;
        window.addEventListener('beforeunload', function(e) {
            if (!isExiting) {
                e.preventDefault();
                e.returnValue = '';
                showExitConfirmation();
                return 'Are you sure you want to leave?';
            }
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                e.preventDefault();
                showExitConfirmation();
            }
        });
        function showExitConfirmation() {
            const exitPopup = document.getElementById('exitConfirmation');
            if (exitPopup) {
                exitPopup.style.display = 'block';
            }
        }
        function cancelExit() {
            const exitPopup = document.getElementById('exitConfirmation');
            if (exitPopup) {
                exitPopup.style.display = 'none';
            }
        }
        function confirmExit() {
            isExiting = true;
            logout();
        }

        // The script tag ends here

    </script>
</body>
</html>